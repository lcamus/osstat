---
title: "Our statistics - STC report"
output:
  html_document
---


```{r setup, include=TRUE, echo=FALSE}
suppressMessages(suppressWarnings(library(highcharter)))
library(ISOcodes)
suppressMessages(suppressWarnings(library(dplyr)))
#library(dplyr)
load("data/d.RData")
v <- d[["Live"]][["getLastVisitsDetails:Visits"]]
```

```{r echo=FALSE}
visitorType <- setNames(as.data.frame(table(v$visitorType)),c("visitorType","number"))

highchart() %>%
  hc_chart(type="pie") %>%
  hc_title(text="New visitors vs Returning visitors") %>%
  hc_subtitle(text="in cumulated number of visits for 3 months") %>%
  hc_series(
    list(
      data = list(
        list(
          name=as.character(visitorType$visitorType[1]),
          y=visitorType$number[1],
          sliced=T, selected=T),
        list(
          name=as.character(visitorType$visitorType[2]),
          y=visitorType$number[2])
      )
    )
  ) %>%
  hc_tooltip(
    headerFormat="",
    pointFormat="{point.y}") %>%
  hc_add_theme(hc_theme_elementary())

rm(visitorType)

```

<p/><hr>

```{r echo=FALSE}

freqdis <- function() {

  v$visitDuration <- as.numeric(as.character(v$visitDuration))

  duration <- v$visitDuration/60
  breaks <- seq(0,max(duration),by=1)
  duration.cut = cut(duration, breaks, right=FALSE)
  duration.freq = table(duration.cut)

  duration.cumfreq <- cumsum(duration.freq)
  duration.cumfreq = cbind(duration.cumfreq/tail(duration.cumfreq,1))

  highchart() %>%
    hc_title(text="Cumulated frequency of Visits duration") %>%
    hc_subtitle(text="based on visits for 3 months") %>%
    hc_chart(type="line") %>%
    hc_yAxis(
      title = list(text = "percent")) %>%
    hc_xAxis(
      categories = head(rownames(duration.cumfreq),60),
      title = list(text = "minutes"),
      plotBands=list(
        list(
          color="#FCFFC5",
          from=0,
          to=4
        )
      )
      ) %>%
    hc_series(
      list(
        name = "visits duration",
        data = setNames(head(duration.cumfreq[,1],60)*100,NULL)
      )
    ) %>%
    hc_tooltip(
      headerFormat="visits duration in <b>{point.key}</b> minutes<br>",
      pointFormat="up to <b>{point.y:.0f}</b> % of total visits") %>%
    hc_add_theme(hc_theme_elementary()) %>%
    hc_annotations(
      list(
        xValue=8,
        yValue=88,
        title= list(text="90 % of visits duration<br>are below 5 min")
      )
    )

}

freqdis()

```

<p/><hr>

```{r echo=FALSE}

referrerTypeName <- setNames(
  head(
    as.data.frame(
      sort(
        table(as.character(v$referrerTypeName)),
        decreasing=T)
    ),
    3),
  c("referrerTypeName","number")
)
referrerTypeName$referrerTypeName <- as.character(referrerTypeName$referrerTypeName)
referrerTypeName$referrerTypeName[1] <- paste0(
  as.character(referrerTypeName$referrerTypeName[1])," & social networks")

highchart() %>%
  hc_chart(type="pie") %>%
  hc_title(text="Visitors entry mode") %>%
  hc_subtitle(text="in cumulated number of visits for 3 months") %>%
  hc_plotOptions(
    pie = list(
      dataLabels = list(
        enabled = TRUE,
        format="<b>{point.name}</b><br>{point.percentage:.0f} %"
      ),
      enableMouseTracking = T,
      distance=-30)
  ) %>%
  hc_series(
    list(
      data = list(
        list(
          name=as.character(referrerTypeName$referrerTypeName[1]),
          y=referrerTypeName$number[1],
          sliced=F, selected=F),
        list(
          name=as.character(referrerTypeName$referrerTypeName[2]),
          y=referrerTypeName$number[2],
          sliced=F, selected=F),
        list(
          name=as.character(referrerTypeName$referrerTypeName[3]),
          y=referrerTypeName$number[3],
          sliced=T, selected=T)
      )
    )
  ) %>%
  hc_tooltip(
    headerFormat="",
    pointFormat="{point.y}") %>%
  hc_add_theme(hc_theme_elementary())

```

<p/><hr>

```{r echo=FALSE}

lc <- as.data.frame(
  t(
    table(v[v$languageCode!="",]$languageCode)
  ),
  stringAsFactors=F)
lc <- lc[lc$Freq!=0,]
lc$Var2 <- as.character(lc$Var2)
lc$Var1 <- sapply(strsplit(lc$Var2,"-"),"[",1)
lc <- setNames(aggregate(Freq~Var1,lc,sum),c("Var1","n"))

data("ISO_639_2")
lc <- merge(lc,ISO_639_2[,c("Alpha_2","Name")],by.x=c("Var1"),by.y=c("Alpha_2"))
lc <- lc[order(-lc$n),]
lc$Name <- gsub("(,|;).+","",lc$Name)

cs <- cumsum(lc$n/sum(lc$n))<0.96

suppressWarnings(
  highchart() %>%
    hc_title(text = "Visitors languages") %>%
    hc_subtitle(text="in cumulated number of visits for 3 months") %>%
    hc_plotOptions(
      pie = list(
        colorByPoint = TRUE, center = c('30%', '30%'),
        size = 120,
        dataLabels = list(
          enabled = T,
          format="<b>{point.name}</b><br>{point.percentage:.0f} %"
        )
      )
    ) %>%
    hc_xAxis(categories = lc[cs,]$Name) %>%
    hc_add_series(data = lc[cs,]$n, type="column", name = "top 20 visitors languages") %>%
    hc_add_series(
      data=setNames(
        data.frame(
          c(paste0("top ",nrow(lc[cs,])," languages"),
            paste0("others languages (",nrow(lc[!cs,]),")")),
          c(sum(lc[cs,]$n),sum(lc[!cs,]$n))
        ),
        c("category","value")
      ),
      type="pie",
      hcaes(name = category, y = value),
      name="number of visits") %>%
    hc_add_theme(hc_theme_elementary())
)

rm(lc,cs,ISO_639_2)

```

<p/><hr>

```{r echo=FALSE}

#mapdata <- get_data_from_map(download_map_data("custom/world"))

cc <- setNames(data.frame(t(table(v$countryCode)))[,c("Var2","Freq")],c("countryCode","nbVisits"))
cc$countryCode <- as.character(cc$countryCode)

c1 <- function() {
  hcmap(map = "custom/world", download_map_data=T, data=cc, joinBy=c("hc-key","countryCode"), value="nbVisits",
        name="number of visits") %>%
    hc_credits(enabled=F) %>%
    hc_title(text = "Visitors country") %>%
    hc_subtitle(text="in cumulated number of visits for 3 months") %>%
    hc_add_theme(hc_theme_elementary()) %>%
    hc_mapNavigation(enabled = TRUE)
}

cc10 <- head(cc[order(-cc$nbVisits),],10)
data("ISO_3166_1")
ISO_3166_1$Alpha_2 <- tolower(ISO_3166_1$Alpha_2)
m <- merge(x=cc10, y=ISO_3166_1, by.x="countryCode", by.y="Alpha_2")
cc10 <- m[order(-m$nbVisits),c("countryCode","Name","nbVisits")]

c2 <- function() {
  highchart() %>%
    hc_title(text = "top 10") %>% 
    hc_xAxis(categories = cc10$Name) %>%
    hc_add_series(cc10, type="bar", name = "number of visits",
                  hcaes(name = countryCode, y = nbVisits), showInLegend = T) %>%
    hc_add_theme(hc_theme_elementary())
}

```

<table width="100%"><tr width="100%"><td width="50%">

```{r echo=FALSE}
c1()
```

</td><td width="50%">

```{r echo=FALSE}
c2()
```

</td></tr></table>
<p/><hr>

```{r echo=FALSE}

vt <- d[["VisitTime"]][["getVisitInformationPerLocalTime"]]
vt <- vt[vt$date>=min(v$date),]
vt$nb_visits <- as.numeric(vt$nb_visits)
vt$nb_actions <- as.numeric(vt$nb_actions)

av <- aggregate(nb_visits~label,vt,sum)
av$label <- as.numeric(sub("h","",as.character(av$label)))
av <- av[order(av$label),]

c_vh_v <- highchart() %>%
  hc_title(text = "Visits hours") %>%
  hc_subtitle(text="in cumulated number of visits for 3 months") %>%
  hc_xAxis(categories = av$label) %>%
  hc_chart(polar=T) %>%
  hc_add_series(av, type="column", name = "number of visits",
                hcaes(name = label, y = nb_visits), showInLegend = T) %>%
  hc_add_theme(hc_theme_elementary())

aa <- aggregate(nb_actions~label,vt,sum)
aa$label <- as.numeric(sub("h","",as.character(aa$label)))
aa <- aa[order(aa$label),]

c_vh_a <- highchart() %>%
  hc_title(text = "Visits hours") %>%
  hc_subtitle(text="in cumulated number of actions for 3 months") %>%
  hc_xAxis(categories = aa$label) %>%
  hc_chart(polar=T) %>%
  hc_add_series(aa, type="column", name = "number of actions",
                hcaes(name = label, y = nb_actions), showInLegend = T) %>%
  hc_add_theme(hc_theme_elementary())

```
<table width="100%"><tr width="100%"><td width="50%">

```{r echo=FALSE}
c_vh_v
```

</td><td width="50%">

```{r echo=FALSE}
c_vh_a
```

</td></tr></table>
<p/><hr>

```{r echo=FALSE}

p <- d[["Actions"]][["getPageUrls"]]
p <- p[p$date>="2017-03-01",]
p$label <- as.character(p$label)

# pat <- "(?<=^.*)\\?.*$"
# m_v <- regmatches(p$label,regexpr(pat,p$label,perl=T))
# m_i <- grepl(pat,p$label,perl=T)




```

