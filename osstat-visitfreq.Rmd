---
title: "osstat"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
---

```{r setup, include=FALSE}
library(flexdashboard)
suppressMessages({
  library(scatterD3)
  library(ggplot2)
})
library(plotly)
library(countrycode)
library(formattable)
library(slickR)
library(svglite)
library(dplyr)
load("data/d.RData")
load("data/refCountry.RData")
```

Countries
===================================== 

Visits summary
===================================== 

Visit frequency
===================================== 

```{r}
growth <- function(v) {
  growth0 <- function(x)x/lag(x)-1  
  l <- lowess(v)
  res <- round(growth0(c(l$y[1],l$y[length(l$y)]))*100)
  res <- res[2]
  return(res)
}
```

Row
-----------------------------------------------------------------------

### Days

```{r}
data <- d[["VisitFrequency"]][["get"]]
data <- data[order(data$date),]
begin <- min(data$date)
value <- max(data$date)-begin
valueBox(value, caption=paste0("Days (from ",begin,")"), icon = "fa-calendar")
```

### Returning Visits (Average Growth Rate)

```{r}
data$nb_visits_returning <- as.numeric(as.character(data$nb_visits_returning))
value <- growth(data$nb_visits_returning)
valueBox(paste0(value," %"), icon = "fa-users", color=ifelse(value>0,"success","warning"))
```

### Returning Unique visitors (AGR)

```{r}
data$nb_uniq_visitors <- as.numeric(as.character(data$nb_uniq_visitors_returning))
value <- growth(data$nb_uniq_visitors_returning)
valueBox(paste0(value," %"), icon = "fa-user-plus", color=ifelse(value>0,"success","warning"))
```

### Returning Actions (AGR)

```{r}
data$nb_actions_returning <- as.numeric(as.character(data$nb_actions_returning))
value <- growth(data$nb_actions_returning)
valueBox(paste0(value," %"), icon = "fa-dot-circle-o", color=ifelse(value>0,"success","warning"))
```

### Returning Average time on site (AGR)

```{r}
data$avg_time_on_site_returning <- as.numeric(as.character(data$avg_time_on_site_returning))
value <- growth(data$avg_time_on_site_returning)
valueBox(paste0(value," %"), icon = "fa-clock-o", color=ifelse(value>0,"success","warning"))
```

### Returning Bounce rate (AGR)

```{r}
data$bounce_rate_returning <- as.numeric(gsub("%","",as.character(data$bounce_rate_returning)))
value <- growth(data$bounce_rate_returning)
valueBox(paste0(value," %"), icon = "fa-futbol-o", color=ifelse(value>0,"warning","success"))
```

Row
-----------------------------------------------------------------------

```{r}

data_vs <- d[["VisitsSummary"]][["get"]]
data_vs <- data_vs[order(data_vs$date),]

getNewvsRet <- function(vr, vs) {
  
  #data_vs[,c(vs)] <- as.numeric(as.character(data_vs[,c(vs)]))
  
  d_ret <- data
  d_ret$val <- as.numeric(as.character(d_ret[,c(vr)]))/as.numeric(as.character(data_vs[,c(vs)]))
  l <- lowess(d_ret$val)
  d_ret$val <- l$y
  d_ret$type <- "Returning"
  d_ret <- d_ret[,c("date","type","val")]
  
  d_new <- d_ret
  d_new$val <- abs(1-d_new$val)
  d_new$type <- "New"
  d_new <- d_new[,c("date","type","val")]
  
  d_m <- rbind(d_new,d_ret)
  d_m<-d_m[order(d_m$date),]
  
  return(d_m)
  
}

#stacked area chart (visits)

d_m <- getNewvsRet("nb_visits_returning","nb_visits")

vf_1 <- ggplot(d_m, aes(x=date,y=val,group=type,fill=type)) + geom_area(position="fill") +
  ggtitle("visits from visitors (Returning vs New)") +
  scale_fill_discrete(name = "visitors") +
  labs(x="",y="") +
  scale_fill_brewer(palette="PiYG")
  
d_m <- getNewvsRet("nb_uniq_visitors_returning","nb_uniq_visitors")

vf_2 <- ggplot(d_m, aes(x=date,y=val,group=type,fill=type)) + geom_area(position="fill") +
  ggtitle("unique visitors (Returning vs New)") +
  scale_fill_discrete(name = "unique visitors") +
  labs(x="",y="") +
  scale_fill_brewer(palette="PRGn")

d_m <- getNewvsRet("nb_actions_returning","nb_actions")

vf_3 <- ggplot(d_m, aes(x=date,y=val,group=type,fill=type)) + geom_area(position="fill") +
  ggtitle("actions (from Returning vs New visitors)") +
  scale_fill_discrete(name = "actions") +
  labs(x="",y="") +
  scale_fill_brewer(palette="Set3")

d_m <- getNewvsRet("avg_time_on_site_returning","avg_time_on_site")

vf_4 <- ggplot(d_m, aes(x=date,y=val,group=type,fill=type)) + geom_area(position="fill") +
  ggtitle("average time on site (from Returning vs New visitors)") +
  scale_fill_discrete(name = "average time") +
  labs(x="",y="") +
  scale_fill_brewer(palette="BrBG")

#5
data_vs$bounce_rate <- as.numeric(gsub("%","",as.character(data_vs$bounce_rate)))
d_m <- getNewvsRet("bounce_rate_returning","bounce_rate")

vf_5 <- ggplot(d_m, aes(x=date,y=val,group=type,fill=type)) + geom_area(position="fill") +
  ggtitle("bounce rate (from Returning vs New visitors)") +
  scale_fill_discrete(name = "bounce rate") +
  labs(x="",y="") +
  scale_fill_brewer(palette="Set2")

toSVG <- list(
  xmlSVG({show(vf_1)},standalone=T),
  xmlSVG({show(vf_2)},standalone=T),
  xmlSVG({show(vf_3)},standalone=T),
  xmlSVG({show(vf_4)},standalone=T),
  xmlSVG({show(vf_5)},standalone=T)
)

s.in=sapply(toSVG,function(sv){paste0("data:image/svg+xml;utf8,",as.character(sv))})
slickR(s.in,slideId = 'vf',slickOpts = list(dots=T), height = 500,width = '100%')


```

[http://news.google.fr]