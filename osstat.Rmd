---
title: "osstat"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
---

```{r setup, include=FALSE}
library(flexdashboard)
suppressMessages(library(scatterD3))
library(slickR)
library(svglite)
load("data/d.RData")
load("data/refCountry.RData")
```


Row
-----------------------------------------------------------------------


### Countries

```{r}
data <- d[["UserCountry"]][["getCountry"]]
value <- length(unique(data$metadata_code))
valueBox(value, icon = "fa-globe")

```

### Visits

```{r}
value <- paste0(round(sum(as.numeric(data$nb_visits))/1000)," k")
valueBox(value, icon = "fa-users")
```

### Actions

```{r}
value <- paste0(round(sum(as.numeric(data$nb_actions))/1000)," k")
valueBox(value, icon = "fa-dot-circle-o")
```

### Days of traffic

```{r}
value <- max(unique(data$date))-min(unique(data$date))
valueBox(value, icon = "fa-calendar")
```

Row
-----------------------------------------------------------------------

### Traffic by Country

```{r}

df<-setNames(aggregate(cbind(as.numeric(nb_visits), as.numeric(nb_actions))~metadata_code,data=d[["UserCountry"]][["getCountry"]], sum),c("country","nb_visits","nb_actions"))

clusters <- scale(df[,c("nb_visits","nb_actions")])
fit <- kmeans(clusters,3)
#df$class_visits <- with(df, ifelse(nb_visits<100, "<100",ifelse(nb_visits>500,">500","100..500")))
df$cluster <- fit$cluster

df <- merge(x=df,y=refCountry,by.x="country",by.y="code")

tooltips <- paste("<b>",df$lib,"</b><br/>nb visits:",df$nb_visits,"<br/>nb actions:",df$nb_actions)

s1 <- scatterD3(data=df, x=nb_visits, y=nb_actions, point_opacity=0.5, hover_size=4, hover_opacity=1, xlab="nb visits", ylab="nb actions", tooltip_text=tooltips)
htmlwidgets::saveWidget(s1,'s1.html')

s2 <- scatterD3(data=df, x=nb_visits, y=nb_actions, point_opacity=0.5, col_var=cluster, hover_size=4, hover_opacity=1, lab=country, xlab="cluster", ylab="nb actions", col_lab="nb visits", tooltip_text=tooltips)
htmlwidgets::saveWidget(s2,'s2.html')

slickR(c(paste0(readLines('s1.html'),collapse='\n'),
         paste0(readLines('s2.html'),collapse='\n')),
       slideId = "scatterD3",
       slideIdx = list(1:2),
       slideType = "iframe",
       slickOpts = list(dots=T),
       height='500px',width='120%')

```



