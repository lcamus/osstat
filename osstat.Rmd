---
title: "osstat"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
---

```{r setup, include=FALSE}
library(flexdashboard)
suppressMessages(library(scatterD3))
library(plotly)
library(countrycode)
library(formattable)
library(slickR)
library(svglite)
load("data/d.RData")
load("data/refCountry.RData")
```


Row
-----------------------------------------------------------------------


### Countries

```{r}
data <- d[["UserCountry"]][["getCountry"]]
value <- length(unique(data$metadata_code))
valueBox(value, icon = "fa-globe")

```

### Visits

```{r}
value <- paste0(round(sum(as.numeric(data$nb_visits))/1000)," k")
valueBox(value, icon = "fa-users")
```

### Actions

```{r}
value <- paste0(round(sum(as.numeric(data$nb_actions))/1000)," k")
valueBox(value, icon = "fa-dot-circle-o")
```

### Days

```{r}
#value <- max(unique(data$date))-min(unique(data$date))
begin <- min(data$date)
value <- max(data$date)-begin
valueBox(value, caption=paste0("Days (from ",begin,")"), icon = "fa-calendar")
```

Row
-----------------------------------------------------------------------

### Traffic by Country

```{r}

df<-setNames(aggregate(cbind(as.numeric(nb_visits), as.numeric(nb_actions))~metadata_code,data=d[["UserCountry"]][["getCountry"]], sum),c("country","nb_visits","nb_actions"))

clusters <- scale(df[,c("nb_visits","nb_actions")])
fit <- kmeans(clusters,3)
centers <- as.data.frame(scale(fit$centers))
centers$score <- with(centers,nb_visits+nb_actions)
#df$cluster <- order(-scale(fit$centers))[fit$cluster]
df$cluster <- order(-centers$score)[fit$cluster]
#df$cluster <- fit$cluster

df$ratio_visits <- percent(with(df, nb_visits/sum(nb_visits)),digits=1)
df$ratio_actions <- percent(with(df, nb_actions/sum(nb_actions)),digits=1)
df$score <- percent(with(df, (ratio_visits+ratio_actions)/2),digits=1)

df <- merge(x=df,y=refCountry,by.x="country",by.y="code")

tooltips <- paste("<b>",df$lib,"</b><br/>nb visits:",df$nb_visits,"<br/>nb actions:",df$nb_actions)
s1 <- scatterD3(data=df, x=nb_visits, y=nb_actions, point_opacity=0.5, hover_size=4, hover_opacity=1, xlab="nb visits", ylab="nb actions", tooltip_text=tooltips)
htmlwidgets::saveWidget(s1,'s1.html')

s2 <- scatterD3(data=df, x=nb_visits, y=nb_actions, point_opacity=0.5, col_var=cluster, hover_size=4, hover_opacity=1, lab=country, xlab="nb visits", ylab="nb actions", col_lab="cluster", tooltip_text=tooltips)
htmlwidgets::saveWidget(s2,'s2.html')

p1 <- plot_ly(aggregate(score~cluster,df,sum), labels=~cluster, values=~score, type='pie',
              showlegend=T,
              insidetextfont = list(color = '#FFFFFF'),
              marker = list(colors = c("green","red","blue"),
                            line = list(color = '#FFFFFF', width = 1))
) %>%
  layout(showlegend=T)
htmlwidgets::saveWidget(p1,'p1.html')

data <- df[order(-df$score),c("lib","cluster","score")]
data$rank <- 1:nrow(data)
data <- setNames(data,c("country","cluster","score","rank"))
t1 <- as.datatable(
  formattable(
    data,
    list(
      cluster = formatter("span", style = x ~ ifelse(x == 1, 
                                                     style(color = "orange", font.weight = "bold"), NA)),
      score=color_bar("lightblue"),
      rank = formatter("span", x~paste0("#",x))
    )
  ),
  rownames=F, class = "compact order-column hover", filter="top",
  options=list(columnDefs=list(list(className='dt-center',targets=c(1,3))))
) %>%
  DT::formatStyle(c("rank"),fontWeight="bold")
htmlwidgets::saveWidget(t1,'t1.html')

# geo map
g <- list(
  showframe = F,
  showcoastlines = T,
  projection = list(type = 'Mercator')
)
l <- list(color = toRGB("grey"), width = 0.5)
m1 <-  plot_geo(df) %>%
  add_trace(
    z=~round(score*100,1),
    locations=~countrycode(as.vector(country),origin="iso2c",destination="iso3c"),
    text=~lib,
    marker = list(line = l),
    colors='Blues'
  ) %>%
  layout(geo=g, title="") %>%
  colorbar(title = '% of global traffic')
htmlwidgets::saveWidget(m1,'m1.html')

slickR(c(paste0(readLines('s1.html'),collapse='\n'),
         paste0(readLines('s2.html'),collapse='\n'),
         paste0(readLines('p1.html'),collapse='\n'),
         paste0(readLines('t1.html'),collapse='\n'),
         paste0(readLines('m1.html'),collapse='\n')),
       slideId = "countries",
       slideIdx = list(1:5),
       slideType = "iframe",
       slickOpts = list(dots=T),
       #       height='500px',width='100%')
       height='500px',width='1400px')

```


