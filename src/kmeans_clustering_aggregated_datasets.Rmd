---
title: "K-means clustering on aggregated datasets"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

```{r}
f <- "../data/os-aggregates_2017-10-02-2018-04-13.RData"
if(!exists("ag")) load(f)
rm(f)
```
```{r}
wssplot <- function(data, nc=15, seed=1234){
  wss <- (nrow(data)-1)*sum(apply(data,2,var))
  for (i in 2:nc){
    set.seed(seed)
    wss[i] <- sum(kmeans(data, centers=i)$withinss)}
  plot(1:nc, wss, type="b", xlab="Number of Clusters",
       ylab="Within groups sum of squares")}
```

```{r}
# module <- "VisitFrequency"
# method <- "get"
module <- "VisitFrequency"
method <- "get"
g <- ag[[module]][[method]]
rownames(g) <- 1:nrow(g)

g0 <- g[,which(sapply(names(g),function(x) is.numeric(g[,x])))] #filter on numeric variables
# g0 <- g0[,which(!names(g0) %in% "nb_users_returning")] #useless variable
g0 <- scale(g0)

```

```{r}
#clustering K-Means
wssplot(g0, nc=6)
```

```{r}
k <- kmeans(g0,2) #k=2
# k <- kmeans(g0,3) #k=3
```

```{r}
require(cluster)
clusplot(g0, k$cluster, main='2D representation of the Cluster solution',
         color=TRUE, shade=TRUE,
         labels=2, lines=0)
```

```{r}
g <- ag[["VisitTime"]][["getByDayOfWeek"]]
g <- na.omit(g)
g <- g[-c(8,9,89),] #outliers
rownames(g) <- 1:nrow(g)

g0 <- g[,which(sapply(names(g),function(x) is.numeric(g[,x])))] #filter on numeric variables
g0 <- g0[,which(!names(g0) %in% "nb_users")] #useless variable
g0 <- scale(g0)

```

```{r}
#clustering K-Means
wssplot(g0, nc=6)
```

```{r}
k <- kmeans(g0,2) #k=2
# k <- kmeans(g0,3) #k=3
```

```{r}
clusplot(g0, k$cluster, main='2D representation of the Cluster solution',
         color=TRUE, shade=TRUE,
         labels=2, lines=0)
```

```{r}
module <- "VisitsSummary"
method <- "get"
g <- ag[[module]][[method]]
g <- g[-c(8,9,89,44),] #outliers
rownames(g) <- 1:nrow(g)

g0 <- g[,which(sapply(names(g),function(x) is.numeric(g[,x])))] #filter on numeric variables
g0 <- scale(g0)

```

```{r}
#clustering K-Means
wssplot(g0, nc=6)
```

```{r}
k <- kmeans(g0,2)
```

```{r}
clusplot(g0, k$cluster, main='2D representation of the Cluster solution',
         color=TRUE, shade=TRUE,
         labels=2, lines=0)
```

```{r}
getCluster <- function(module,method,outliers,n) {
  
  g <- ag[[module]][[method]]
  if (!is.null(outliers))
    g <- g[-outliers,] #remove outliers
  rownames(g) <- 1:nrow(g)
  g <- g[order(g$date,g$label),]
  
  g0 <- g[,which(sapply(names(g),function(x) is.numeric(g[,x])))] #filter on numeric variables
  va <- names(g0)
  g0 <- scale(g0)
  
  #clustering K-Means
  wssplot(g0, nc=6)
  
  k <- kmeans(g0,n)
  clusplot(g0, k$cluster, main=paste0("Clusters ",module,":",method),
           color=TRUE, shade=TRUE,
           labels=2, lines=0)
  
  print(va)
    
}
```


```{r}
module <- "UserCountry"
method <- "getCountry"
# outliers <- c()
outliers <- c(420,5186,499,2636)
n.clusters <- 2
getCluster(module,method,outliers,n.clusters)
```

```{r}
module <- "UserCountry"
method <- "getRegion"
# outliers <- c()
outliers <- c(711,8969,867,4844)
n.clusters <- 2
getCluster(module,method,outliers,n.clusters)
```

```{r}
module <- "UserCountry"
method <- "getContinent"
# outliers <- c()
outliers <- c(54,615,62,311)
n.clusters <- 2
getCluster(module,method,outliers,n.clusters)
```

```{r}
module <- "UserCountry"
method <- "getCity"
# outliers <- c()
outliers <- c(919,11661,1347,6431)
n.clusters <- 2
getCluster(module,method,outliers,n.clusters)
```
