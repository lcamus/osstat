---
title: "Our statistics - STC report"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
library(highcharter)
v <- d[["Live"]][["getLastVisitsDetails:Visits"]]

visitorType <- setNames(as.data.frame(table(v$visitorType)),c("visitorType","number"))

highchart() %>%
  hc_chart(type="pie") %>%
  hc_title(text="New visitors vs Returning visitors") %>%
  hc_subtitle(text="in cumulated number of visits for 6 months") %>%
  hc_series(
    list(
      data = list(
        list(
          name=as.character(visitorType$visitorType[1]),
          y=visitorType$number[1],
          sliced=T, selected=T),
        list(
          name=as.character(visitorType$visitorType[2]),
          y=visitorType$number[2])   
      )
    )
  ) %>%
  hc_tooltip(
    headerFormat="",
    pointFormat="{point.y}") %>%
  hc_add_theme(hc_theme_538())

rm(visitorType)

```

```{r}
freqdis <- function() {
  
  v$visitDuration <- as.numeric(as.character(v$visitDuration))
  
  #duration <- v[v$visitDuration<2400,]$visitDuration/60
  duration <- v$visitDuration/60
  breaks <- seq(0,max(duration),by=1)
  duration.cut = cut(duration, breaks, right=FALSE) 
  duration.freq = table(duration.cut)
  
  duration.cumfreq <- cumsum(duration.freq)
  duration.cumfreq = cbind(duration.cumfreq/tail(duration.cumfreq,1))
  
  highchart() %>%
    hc_title(text="Cumulated frequency of Visits duration") %>%
    hc_subtitle(text="based on visits for 6 months") %>%
    hc_chart(type="line") %>%
    hc_yAxis(
      title = list(text = "percent")) %>%
    hc_xAxis(
      categories = head(rownames(duration.cumfreq),60),
      title = list(text = "minutes"),
      plotBands=list(
        list(
          color="#FCFFC5",
          from=0,
          to=4
        )
      )
      ) %>%
    hc_series(
      list(
        name = "visits duration",
        data = setNames(head(duration.cumfreq[,1],60)*100,NULL)
      )
    ) %>%
    hc_tooltip(
      headerFormat="visits duration in <b>{point.key}</b> minutes<br>",
      pointFormat="up to <b>{point.y:.0f}</b> % of total visits") %>%
    hc_add_theme(hc_theme_538()) %>%
    hc_annotations(
      list(
        xValue=8,
        yValue=88,
        title= list(text="90 % of visits duration<br>are below 5 min")
      )
    )
  
}

freqdis()

```


```{r}

referrerTypeName <- setNames(
  head(
    as.data.frame(
      sort(
        table(as.character(v$referrerTypeName)),
        decreasing=T)
    ),
    3),
  c("referrerTypeName","number")
)
referrerTypeName$referrerTypeName <- as.character(referrerTypeName$referrerTypeName)
referrerTypeName$referrerTypeName[1] <- paste0(
  as.character(referrerTypeName$referrerTypeName[1])," & social networks")

highchart() %>%
  hc_chart(type="pie") %>%
  hc_title(text="Visitors entry mode") %>%
  hc_subtitle(text="in cumulated number of visits for 6 months") %>%
  hc_plotOptions(
    pie = list(
      dataLabels = list(
        enabled = TRUE,
        format="<b>{point.name}</b><br>{point.percentage:.0f} %"
      ),
      enableMouseTracking = T,
      distance=-30)
  ) %>%
  hc_series(
    list(
      data = list(
        list(
          name=paste0(
            as.character(referrerTypeName$referrerTypeName[1])
            ),
          y=referrerTypeName$number[1],
          sliced=F, selected=F),
        list(
          name=as.character(referrerTypeName$referrerTypeName[2]),
          y=referrerTypeName$number[2],
          sliced=F, selected=F),
        list(
          name=as.character(referrerTypeName$referrerTypeName[3]),
          y=referrerTypeName$number[3],
          sliced=T, selected=T) 
      )
    )
  ) %>%
  hc_tooltip(
    headerFormat="",
    pointFormat="{point.y}") %>%
  hc_add_theme(hc_theme_538())

```

Add a new chunk by cIlicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).
